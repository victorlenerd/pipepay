{"version":3,"sources":["webpack:///./src/api/resources/payment/payment.controller.js"],"names":["secret","generateController","createOne","req","res","hash","crypto","createHmac","update","body","digest","event","data","reference","transaction","amount","paid","invoice_code","customer","first_name","last_name","email","console","log","headers","InvoiceModel","findOneAndUpdate","$set","status","new","err","doc","send","error","Error","_id","type","whoPaysDeliveryFee","marchantName","marchantEmail","marchantBankCode","deliveryAmount","marchantAccountNumber","Transfer","PaymentModel","create","customerEmail","invoiceId","success","message","getOne","id","params","findOne"],"mappings":"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","file":"main.e65a5ef72115a8a16a87.hot-update.js","sourcesContent":["import crypto from 'crypto';\nimport PaymentModel from './payment.model';\nimport InvoiceModel from '../invoice/invoice.model';\nimport * as mailer from '../../modules/mailer';\nimport generateController from '../../modules/generateController';\nimport Transfer from '../../modules/transfer';\n\nconst secret = process.env.PAYSTACK_SECRET;\n\nexport default generateController(PaymentModel, {\n    createOne: (req, res) => {\n        const hash = crypto.createHmac('sha512', secret).update(JSON.stringify(req.body)).digest('hex');\n        const { event, data: { transaction: { reference }, amount, paid, invoice_code, customer: { first_name, last_name, email } } } = req.body;\n        console.log({ hash, event, paid });\n        if (hash === req.headers['x-paystack-signature'] && event === 'invoice.update' && paid) {\n            InvoiceModel.findOneAndUpdate({ invoice_code }, { $set :{ status: 'paid' } }, { new: true }, async (err, doc) => {\n                if (err) {\n                    console.log(err);\n                    return res.status(400).send({ error: new Error(error), status: false });\n                }\n\n                const { \n                    _id,\n                    type,\n                    whoPaysDeliveryFee,\n                    marchantName,\n                    marchantEmail,\n                    marchantBankCode,\n                    deliveryAmount,\n                    marchantAccountNumber\n                } = doc;\n                \n                console.log('updated invoice'+invoice_code);\n\n                try {\n                    if (type === 'good') {\n                        await Transfer(marchantName, marchantAccountNumber, marchantBankCode, deliveryAmount);\n                        await PaymentModel.create({ customerEmail: email, marchantEmail, reference, deliveryAmount, invoiceId: _id });\n                        console.log('updated payment'+reference);\n                    }\n\n                    await mailer.sendReceiptMail(`${first_name} ${last_name}`, email, marchantEmail, amount);\n                    console.log('sent receipt to'+email);\n                    res.status(200).send({ success: true });\n                } catch (err) {\n                    console.log(err);\n                    return res.status(400).send({ error: { message: 'Could not send mail' }, success: false });\n                }\n            })\n        } else {\n            res.status(400).send({ success: false });\n        }\n    },\n    getOne: (req, res) => {\n        var id = req.params.invoiceId;\n        PaymentModel.findOne({ invoiceId: id }, function (err, doc) {\n            if (err) res.status(401).send({ success: false, error: { ...err } });\n            res.status(200).send({ success: true, data: doc });\n        });\n    }\n});"],"sourceRoot":""}